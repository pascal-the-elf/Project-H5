<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ILLUSION</title>
        <meta name="apple-mobile-web-app-capable" content="yes">
            <meta name="apple-mobile-web-app-status-bar-style" content="default">
                <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
                <link href="https://fonts.googleapis.com/css?family=Amatic+SC:700&display=swap" rel="stylesheet" />
                <link rel="stylesheet" href="https://cdn.pannellum.org/2.4/pannellum.css" />
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css" />
                <style>
                    body {
                        font-family: 'Amatic SC', cursive;
                    }
                h1 {
                    font-family: 'Amatic SC', cursive;
                }
                .show {
                    z-index: 5;
                }
                #screen {
                    background-color: white;
                    width: 100%;
                    height: 100%;
                    position: fixed;
                    top: 0;
                    left: 0;
                    z-index: 0;
                }
                #panorama {
                    width: 100%;
                    height: 100%;
                    position: fixed;
                    top: 0;
                    left: 0;
                    filter: brightness(.7) grayscale(.6) saturate(.6);
                }
                #container {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100vh;
                    z-index: 5;
                }
                #image {
                    width: 100%;
                    height: 100%;
                    position: fixed;
                    top: 0;
                    left: 0;
                    z-index: 2;
                }
                #book {
                    z-index: 10;
                    position: fixed;
                    bottom: 10px;
                    right: 10px;
                    display: none;
                    cursor: pointer;
                }
                #orientation {
                    z-index: 10;
                    position: fixed;
                    bottom: 10px;
                    right: 10px;
                    display: none;
                    cursor: pointer;
                }
                #dialog {
                    z-index: 10;
                    position: fixed;
                    top: 0px;
                    left: 0px;
                    width: calc(100vw - 20px);
                    height: 3rem;
                    margin: 10px;
                    line-height: 2rem;
                    background-color: rgba(0, 0, 0, 0.6);
                    display: none;
                    color: white;
                    font-size: 2rem;
                }
                #dialog > span {
                    position: relative;
                    top: 0.5rem;
                    left: 1rem;
                }
                #FADE {
                    z-index: 200;
                    position: fixed;
                    top: 0;
                    left: 0;
                    height: 100%;
                    width: 100vw;
                    background-color: rgba(0, 0, 0, 1);
                }
                .fade-out {
                    display: block;
                    animation-name: ani-fade-out;
                    animation-duration: 1.5s;
                    animation-fill-mode: forwards;
                }
                .fade-in {
                    animation-name: ani-fade-in;
                    animation-duration: 1.5s;
                    animation-fill-mode: forwards;
                }
                #text-loading {
                    z-index: 201;
                    color: white;
                    font-size: 2rem;
                    position: fixed;
                    bottom: 10px;
                    right: 10px;
                    animation-name: ani-text-loading;
                    animation-duration: 4s;
                    animation-iteration-count: infinite;
                }
                @keyframes ani-fade-out {
                    from {
                        background-color: rgba(0, 0, 0, 0);
                    }
                    to {
                        background-color: rgba(0, 0, 0, 1);
                    }
                }
                @keyframes ani-fade-in {
                    from {
                        background-color: rgba(0, 0, 0, 1);
                    }
                    to {
                        display: none !important;
                        background-color: rgba(0, 0, 0, 0);
                    }
                }
                @keyframes ani-text-loading {
                    0% {
                        content: "oooO";
                    }
                    25% {
                        content: "ooOo";
                    }
                    50% {
                        content: "oOoo";
                    }
                    75% {
                        content: "Oooo";
                    }
                    100% {
                        content: "oooO";
                    }
                }
                
                iframe#rpg1 {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100%;
                    border: 0;
                    z-index: -100;
                }
                iframe#rpg2 {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100%;
                    border: 0;
                    z-index: -100;
                }
                iframe#rpg3 {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100%;
                    border: 0;
                    z-index: -100;
                }
                #hhhhh {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100%;
                    border: 0;
                    z-index: -100;
                }
                </style>
    </head>
    <body>
        <iframe id="rpg1" src="https://pascal-the-elf.github.io/Project-H5/rpg/1/"></iframe>
        <iframe id="rpg2" src="https://pascal-the-elf.github.io/Project-H5/rpg/2/"></iframe>
        <iframe id="rpg3" src="https://pascal-the-elf.github.io/Project-H5/rpg/3/"></iframe>
        <img src="https://pascal-the-elf.github.io/Project-H5/rpg/0.jpg"></img>
        <audio src="./res/bgm.mp3" autoplay loop style="display: none;"></audio>
        <p id="text-loading"></p>
        <div id="FADE" class=""></div>
        <img id="image" src="https://i.ytimg.com/vi/AtGTot98UAo/maxresdefault.jpg"></img>
        <div id="container">
            <div class="w3-center show">
                <h1 style="position: relative; bottom: 2rem; font-size: 5rem; letter-spacing: 8px;">Illusion</h1>
                <button id="start" class="w3-button w3-round-large" style="font-size: 2rem; letter-spacing: 8px; display: none" onclick="gameStart();">START</button>
            </div>
        </div>
        <div id="screen"></div>
        <div id="panorama"></div>
        <div id="book" onclick="showItem(2)">
            <i class="fas fa-book fa-5x w3-text-blue"></i>
        </div>
        <div id="orientation" onclick="toggleOrientation()" class="w3-text-green">
            <i class="fas fa-mobile-alt fa-5x"></i>
        </div>
        <div id="dialog">
            <span></span>
        </div>
        <script type="text/javascript" src="https://cdn.pannellum.org/2.4/pannellum.js" onload="setTimeout(()=>{document.getElementById('text-loading').style.display = 'none';document.getElementById('start').style.display = ''}, 2000)"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8" async></script>
        <script>
            var BOOOOOOOK = 0, orientation = true;
            const fade = document.getElementById("FADE");
            fadeIn();
            const oneperson = document.getElementById("panorama");
            oneperson.style.zIndex = "-1";
            var mobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            var CPs=[0,0,0,0,0,0,0,0,0,0], CHECKPOINT = 0;
            setInterval(()=>{
                        document.getElementById("text-loading").innerHTML = "oooO";
                        setTimeout(()=>{document.getElementById("text-loading").innerHTML = "ooOo";}, 250);
                        setTimeout(()=>{document.getElementById("text-loading").innerHTML = "oOoo";}, 500);
                        setTimeout(()=>{document.getElementById("text-loading").innerHTML = "Oooo";}, 750);
                        }, 1000);
                        var ITEMS = [
                                     {
                                     "title": "一張被油墨弄髒的紙",
                                     "content": '<img src="./res/doc1.jpg" style="max-width: 100%; max-height: 80vh;"></img>'
                                     },
                                     {
                                     "title": "",
                                     "content": '<iframe src="https://jacoblincool.gitbook.io/travel-in-forest/" style="min-width: 100%; min-height: 70vh; max-height: 80vh; border: 0;"></iframe>'
                                     }
                                     ];
                                     var SCENES = {
                                         "default": {
                                             "firstScene": "1",
                                             "showControls": false,
                                             "autoLoad": true
                                         },
                                         
                                         "scenes": {
                                             "1": {
                                                 "title": "小木屋房內",
                                                 "type": "equirectangular",
                                                 "panorama": pic360(1),
                                                 "pitch": -23,
                                                 "yaw": -44,
                                                 "hotSpots": [
                                                              {
                                                              "pitch": -23,
                                                              "yaw": -44,
                                                              "type": "info",
                                                              "text": "一張被油墨弄髒的紙",
                                                              "URL": 'javascript:showItem(1);updateCP(1);canLeaveHouse();'
                                                              },
                                                              {
                                                              "pitch": -14,
                                                              "yaw": -120,
                                                              "type": "info",
                                                              "text": "旅遊手冊",
                                                              "URL": 'javascript:showItem(2);getBook();updateCP(2);canLeaveHouse();'
                                                              }
                                                              ]
                                             },
                                             "2": {
                                                 "title": "小木屋外",
                                                 "type": "equirectangular",
                                                 "panorama": pic360(2),
                                                 "hotSpots": [
                                                              {
                                                              "pitch": 2,
                                                              "yaw": 20,
                                                              "type": "scene",
                                                              "text": "往此處走",
                                                              "URL": "javascript:sceneTo(3)"
                                                              },
                                                              {
                                                              "pitch": 4,
                                                              "yaw": -62,
                                                              "type": "scene",
                                                              "text": "進入小木屋",
                                                              "URL": "javascript:sceneTo(1, -23, -44)"
                                                              }
                                                              ]
                                             },
                                             "3": {
                                                 "title": "森林步道",
                                                 "type": "equirectangular",
                                                 "panorama": pic360(3),
                                                 "hotSpots": [
                                                              {
                                                              "pitch": -3,
                                                              "yaw": 90,
                                                              "type": "scene",
                                                              "text": "往小木屋方向走",
                                                              "sceneId": "2",
                                                              "URL": "javascript:sceneTo(2, 4, -62)"
                                                              },
                                                              {
                                                              "pitch": -5,
                                                              "yaw": -97,
                                                              "type": "scene",
                                                              "text": "往森林深處走",
                                                              "URL": "javascript:sceneTo(4);startFinding();"
                                                              }
                                                              ]
                                             },
                                             "4": {
                                                 "title": "森林深處",
                                                 "type": "equirectangular",
                                                 "panorama": pic360(4),
                                                 "hotSpots": [
                                                              {
                                                              "pitch": 0,
                                                              "yaw": 90,
                                                              "type": "scene",
                                                              "text": "往步道方向走",
                                                              "URL": "javascript:sceneTo(3)"
                                                              }
                                                              ]
                                             }
                                         }
                                     };
        var viewer = pannellum.viewer("panorama", SCENES);
        viewer.on("load",()=>{
                  document.getElementById("text-loading").style.display = "none";
                  fadeIn();
                  if(viewer.isOrientationSupported()) {
                  document.getElementById("orientation").style.display = "block";
                  if(orientation)
                  viewer.startOrientation();
                  }
                  });
                  function sceneTo(x, p=0, y=0) {
                      fadeOut();
                      setTimeout(()=>{
                                 document.getElementById("text-loading").style.display = "block";
                                 viewer.loadScene(x);
                                 viewer.setPitch(p, 0);
                                 viewer.setYaw(y, 0);
                                 oneperson.style.zIndex = "2";
                                 }, 1000);
                  }
        function pic360(x) {
            return (mobile ? "https://pascal-the-elf.github.io/Project-H5/360/"+x+"_low.jpg" : "https://pascal-the-elf.github.io/Project-H5/360/"+x+"_high.jpg");
        }
        function gameStart() {
            document.getElementById("image").style.display = "none";
            document.getElementById("container").style.display = "none";
            sceneTo(1);
            window.forceTEXT = 1;
            setTimeout(()=>{sendText("喔～頭好痛～")}, 1000);
            setTimeout(()=>{sendText("我在哪？")}, 4000);
            setTimeout(()=>{sendText("我怎麼會在這裡？")}, 7000);
            forceTEXT = 0;
            setTimeout(()=>{sendText("這裡有什麼？")}, 10000);
            setTimeout(()=>{Swal.fire("請四處觀察房間物品")}, 12000);
        }
        function showItem(x) {
            Swal.fire(
                      "",
                      ITEMS[x-1].content+"<br><span>"+ITEMS[x-1].title+"</span>"
                      );
        }
        function updateCP(x) {
            if(!CPs[x]) {
                CHECKPOINT++;
                CPs[x] = 1;
            }
        }
        function canLeaveHouse() {
            if(CHECKPOINT >= 2)
            viewer.addHotSpot({"pitch": -8,"yaw": 180,"type": "scene","text": "離開小木屋","URL": "javascript:if(CHECKPOINT>0) {toRPG1(); sceneTo(2, 4, -62);}"});
        }
        function getBook() {
            document.getElementById("orientation").style.right = "calc(10px + 5rem)";
            document.getElementById("book").style.display = "block";
            if(!BOOOOOOOK)
            Swal.fire("現在可以從右下角查看旅遊手冊");
            window.BOOOOOOOK = 1;
        }
        function fadeIn() {
            fade.classList.remove("fade-out");
            fade.classList.add("fade-in");
            setTimeout(()=>{fade.style.display = "none"}, 1500);
        }
        function fadeOut() {
            fade.style.display = "";
            fade.classList.remove("fade-in");
            fade.classList.add("fade-out");
        }
        function toggleOrientation() {
            if(orientation) {
                orientation = false;
                viewer.stopOrientation();
                document.getElementById("orientation").classList.remove("w3-text-green");
                document.getElementById("orientation").classList.add("w3-text-light-gray");
            } else {
                orientation = true;
                viewer.startOrientation();
                document.getElementById("orientation").classList.add("w3-text-green");
                document.getElementById("orientation").classList.remove("w3-text-light-gray");
            }
        }
        
        var d = document.getElementById("dialog");
        var textContainer = d.firstElementChild;
        d.addEventListener("mouseover", ()=>{
                           if(!forceTEXT)
                           clearInterval(window.textFade);
                           });
                           d.addEventListener("mouseout", ()=>{
                                              if(!forceTEXT)
                                              window.textFade = setTimeout(()=>{textContainer.innerHTML = "";d.style.display = "none";}, 5000);
                                              });
                                              function sendText(x) {
                                                  d.style.display = "block";
                                                  textContainer.innerHTML = x;
                                                  if(!forceTEXT)
                                                  window.textFade = setTimeout(()=>{textContainer.innerHTML = "";d.style.display = "none";}, 5000);
                                              }
        function startFinding() {
            forceTEXT = 1;
            setTimeout(()=>{sendText("接下來該怎麼辦...");}, 3000);
            forceTEXT = 0;
            setTimeout(()=>{sendText("來看看手冊好了")}, 6000);
            setTimeout(()=>{Swal.fire("查看手冊中的「傳說故事」")}, 9000);
            setTimeout(()=>{
                       viewer.addHotSpot({"pitch": 0,"yaw": 0,"type": "scene","text": "繼續","URL": "javascript:toRPG2();"});
                       }, 12000);
                       
        }
        function toRPG1() {
            document.getElementById("rpg1").style.zIndex = 200;
            var ii = setInterval(()=>{
                                 if(document.getElementById("rpg1").contentWindow.$gameSwitches._data[6]) {
                                 document.getElementById("rpg1").style.zIndex='-100';
                                 clearInterval(ii);
                                 }
                                 }, 2000);
        }
        function toRPG2() {
            document.getElementById("rpg2").style.zIndex = 200;
            var ii = setInterval(()=>{
                                 if(document.getElementById("rpg2").contentWindow.$gameVariables._data[6]) {
                                 document.getElementById("rpg2").style.zIndex='-100';
                                 toRPG3();
                                 clearInterval(ii);
                                 }
                                 }, 2000);
        }
        function toRPG3() {
            document.getElementById("rpg3").style.zIndex = 200;
            var ii = setInterval(()=>{
                                 if(document.getElementById("rpg3").contentWindow.$gameVariables._data[6]) {
                                 document.getElementById("rpg3").style.zIndex='-100';
                                 document.getElementById("hhhhh").style.zIndex="100";
                                 clearInterval(ii);
                                 }
                                 }, 2000);
        }
        </script>
    </body>
</html>
